---
title: hystrix简介
categories: hystrix
date: 2017-10-26 10:35:58
tags: hystrix
---

## 简介
Hystrix是Netflix开源的延迟容错工具包，用于隔离分布式系统之间的依赖访问，防止级联故障，使得复杂的分布式系统在错误不可避免的条件下仍具有弹性，具有一定程度的自我保护能力。

## 应用
在微服务大行其道的互联网应用中，稍微复杂点的分布式系统都会有很多外部依赖，每个依赖在某些时候或者某些恶劣条件下都不可避免的会产生故障，如果主应用没有隔离这些故障，就会面临被拖垮的风险。

Hystrix官网给出了这样一个栗子：

![](https://clouder123.oss-cn-beijing.aliyuncs.com/hestrix1.png
)
一个应用依赖30个外部服务，每个服务的可用性为4个9（99.99%），那么主应用的可用性即为99.99% ^ 30 = 99.7%,0.3%的故障率意味着每个月有2个多小时的服务不可用，这对于流量很高的互联网应用来说通常是不能容忍的。而且当依赖的外部服务越多，可用性越差。服务正常运行时，如上图所示。当有一个系统延迟很高时，会阻塞整个用户请求：

![](https://clouder123.oss-cn-beijing.aliyuncs.com/hestrix2.png
)
在高并发场景下，单个依赖服务接口超时后会所有服务器上的资源都被耗尽，造成更多级联故障。如下图：

![](https://clouder123.oss-cn-beijing.aliyuncs.com/hestrix3.png
)
因此我们可以得出结论，在有很多外部依赖的服务中，我们有必要将这些依赖隔离管理，从而使延迟和故障被隔离，使得单个接口的故障不会拖垮整个应用。

## 设计原则

通过以上的分析，hystrix的设计原则已经很明了，通过隔离术来提高服务可用性。具体表现在以下几点：

1. 通过线程隔离来防止单个依赖耗尽所有容器内的所有用户线程。
2. 在系统无法处理请求时快速失败，而不是入队，以降低系统负载。
3. 提供失败降级，在必要时让失败对用户透明。
4. 利用隔离术(舱壁、泳道、熔断器模式)来隔离单个依赖对整个系统的影响。
5. 针对系统服务运行的度量、监控、报警，提供优化以满足近实时性的需求。
6. hystrix大部分属性都支持动态配置并且快速应用，从而辅助我们做实时性的修改。
7. 可以隔离应用整个执行过程中失败的影响，不仅仅是通信中。

## 实现原理
那么hystrix到底是如何将这些设计实现，让世界更美好的呢，下面大体看下hestrix的实现。

首先，hestrix可以将所有对外部系统的调用都包装在命令模式的对象HystrixCommand或HystrixObservableCommand中，它通过一个隔离的线程执行远程调用。默认情况下，hestrix支持自动超时机制，也支持手动配置超时时间（通常根据99线）。另外，hestrix会对每个外部依赖都维护一个线程池，如果线程池满了会立即拒绝，而非排队等待。还有就是引入断路器机制以阻断一段时间对特定服务的访问，支持手动开启断路器，或者根据失败率自动开启。在请求失败、超时、拒绝时，可以执行降级逻辑。监控计量数据和配置信息支持动态修改。

![](https://clouder123.oss-cn-beijing.aliyuncs.com/hystix4.png
)
当使用Hystrix来包装依赖服务时，上面的架构即变成如下图所示。每个依赖都相互隔离，当某个依赖延迟发生时只会耗尽其内部资源而不影响其他资源，同时也实现了降级逻辑用于依赖服务发生错误时向用户返回信息。

参考：[Hystix](https://github.com/Netflix/Hystrix/wiki)

